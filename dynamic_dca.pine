//@version=5
indicator("Dynamic DCA Equities/Gold", overlay=true)

// Function to calculate regime based on Close vs SMA200
calc_regime() =>
    sma200 = ta.sma(close, 200)
    var int weeksAbove = 0
    var int weeksBelow = 0
    var int regime = 0
    
    // Check if close is above or below SMA
    if close > sma200
        weeksAbove += 1
        weeksBelow := 0
    else if close < sma200
        weeksBelow += 1
        weeksAbove := 0
    
    // Set regime based on 30 week threshold
    if weeksAbove >= 30
        regime := 1
    else if weeksBelow >= 30
        regime := -1
        
    [close, sma200, regime]

// Hardcoded ticker for S&P 500 divided by Gold
targetTicker = "SP:SPX/TVC:GOLD"

// Request Weekly data for the specific ticker
[weeklyClose, sma200w, regime] = request.security(targetTicker, "W", calc_regime())

// Set background color based on regime
bgcolor(regime == 1 ? color.new(color.yellow, 90) : color.new(color.blue, 90))

var table dcaTable = table.new(position.bottom_right, 1, 1, border_width=1)

// Display recommendation
// If Ratio > SMA200 (Regime 1) -> Gold is cheap relative to SPX
// If Ratio < SMA200 (Regime -1) -> SPX is cheap relative to Gold
table.cell(dcaTable, 0, 0, regime == 1 ? "Recommended DCA:\nGOLD" : "Recommended DCA:\nEquities", text_color=color.white, bgcolor=regime == 1 ? color.new(color.orange, 0) : color.new(color.blue, 0), text_size=size.large)